---
title: "HW5"
author: "Kirienko Nadezhda"
date: "2024-04-10"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
**Домашнее задание 5**
Тема: построение регрессионных моделей и анализ выживаемости.

Цель: научиться пользоваться основными методами регрессионного анализа, разобраться с принципами анализа выживаемости.
Описание ДЗ:
Для выполнения первых двух заданий загрузите датасет Breast Cancer Wisconsin. https://lms.skillfactory.ru/asset-v1:SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv
В колонке diagnosis содержится информация об опухоли (M = злокачественная, B = доброкачественная).
Выполните перечисленные задания.

# загружаю датасет, импортирую требуемые для выполнения заданий библиотеки


```{r}
library(ggplot2)
library(tidyverse)
library(car)
library(survival)
library(ggsurvfit)
library(survminer)

```

PS: почему то датасет без использования функции download.file при загрузке выдавал ошибку
```{r}
download.file("https://lms.skillfactory.ru/asset-v1:SkillFactory+MFTIBIO+SEP2023+type@asset+block@wisconsin_breast_cancer.csv", dest = "cancer.csv")
cancer <- read.csv("cancer.csv",header = TRUE, sep = ",")
head(cancer)
str(cancer)

```
**Задание 1**
Создайте регрессионную модель, которая бы описывала связь среднего радиуса опухоли и средней площади (а), среднего периметра (б), средней симметричности (в).
Постройте графики, на которых отразите регрессионную прямую, и прокомментируйте свои находки.

Для начала  проверим наличие пропущенных значений в интересующих нас колонках
```{r}
colSums(is.na(cancer[c("radius_mean", "area_mean", "perimeter_mean", "symmetry_mean")]))

```
ВЫВОД: пропущенных значений в интересующих нас колонках нет.

Для создания регрессионной модели используем модель линейной регресии (переменные - числовые, непрерывные )
Формулирую гипотезы
H0- нет  статистически значимой зависимости переменной и фактора
H1-есть статистически значимая зависимость переменной и фактора
alpha = 0.05
```{r}
lr1 <- lm(radius_mean ~ area_mean + perimeter_mean + symmetry_mean, data = cancer) 
summary(lr1)

```
Обращает внимание, что значние p-value в трех случаях статистически значимое.
Линейная зависимость между средним радиусом опухоли и средней площадью , средним периметром, средней симметричностью статистически значима.
Общее значение статистики модели 6.511e+04
Общее значение p-value модели < 2.2e-16
Остаточная стандартная ошибка модели 0.1898
Скорректированныйкоэффициент детерминации 0.9971

Анализируя полученные данные можно говорить о создании модели с предсказанием изменчивости среднего радиуса опухоли на 99,7%, либо предположить о переученности модели


Далее нужно убедиться, что требования к линейной регрессионной модели соблюдаются:
1. линейность зависимости факторов (переменной от каждого фактора) - визуальная оценка
2. нормальное распределение остатков - визуальная оценка и тест Шапиро-Уилка
3. гомоскедастичность остатков - визуальная оценка
4. отсутствие  мультиколлинеарности - графики распределения попарно
5. независимость наблюдений
```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и средней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний радиус опухоли") + 
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
cancer %>%
    ggplot(aes(x = perimeter_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и среднего периметра опухоли",
      x = "Средний периметр опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```

```{r}
cancer %>%
    ggplot(aes(x = symmetry_mean, y = radius_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего радиуса и средней симметричности опухоли",
      x = "Средняя симметричность опухоли",
      y = "Средний радиус опухоли") +
    geom_smooth(method = "lm")
    `geom_smooth()` using formula = 'y ~ x'
```
Анализируя три графика - можно говорить о наличии линейной зависимости переменной и указанных факторов

```{r}
qqPlot(residuals(lr1))
```
Наблюдается выраженные  отклонения остатков в левой части графика, поэтому дополнительно проведем тест Шапиро-Уилка на нормальность распределения
```{r}
shapiro.test(residuals(lr1))
```
По результатам теста - p-value = 1.072e-11, что меньше установленной 0,05. Соответственно принимает  гипотеза о ненормальном распределении остатков

```{r}
plot(lr1, which = 1)
```
АНализируя этот график можно сказать о неравномерности распределения остатков
```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = perimeter_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и среднего периметра опухоли",
      x = "Средняя площадь опухоли",
      y = "Средний периметр опухоли")
```
```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость средней площади и средней симметричности опухоли",
      x = "Средняя площадь опухоли",
      y = "Средняя симметричность опухоли")
```
```{r}
cancer %>%
    ggplot(aes(x = perimeter_mean, y = symmetry_mean)) +
    geom_point() +
    labs(title = "Зависимость среднего периметра и средней симметричности опухоли",
      x = "Средняя симметричность опухоли",
      y = "Средний периметр опухоли")
```
Анализируя полученные графики :наблюдается сильная линейная зависимость между средней площадью и средим периметром опухоли. Явление мультиколлинеарности  - ухудшает результат работы модели.

Для улучшения работы модели можно - исключить из факторов  - средний периметр опухоли, а также попробовать поменять переменную.




**Задание 2**
Пусть колонка с диагнозом принимает следующие значения: злокачественная опухоль — 1, а доброкачественная — 0. Постройте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от среднего радиуса (а), средней площади (б), средней текстуры (в).

Постройте графики. Создайте модель, которая бы прогнозировала вероятность возникновения злокачественной опухоли от всех трех перечисленных факторов.

Переименую в столбце с диагнозом значения в соответвтсии с заданием:
```{r}
cancer$diagnosis <- ifelse(cancer$diagnosis == 'M', 1, 0)
head(select(cancer, diagnosis),5)
```
Для создания регрессионной модели используем модель логистической регресии (переменные - категориальные )
Формулирую гипотезы
H0- нет  статистически значимой зависимости переменной и фактора
H1-есть статистически значимая зависимость переменной и фактора
alpha = 0.05
```{r}
glr1 <-
  glm(diagnosis ~ radius_mean + area_mean + texture_mean, data = cancer, family = "binomial")
summary(glr1)
```
Анализ результата:
1 Интерсепт:
вероятность диагностирования злокачественной опухоли выше при нулевых значениях факторов
вероятность диагностирования злокачественной опухоли возрастает с увеличиеним показателя среднего радиуса опухоли
имеется положительная связь: между значениями средней площади и диагностированием доброкачественной опухоли и  средним значением текстуры опухоли и диагностированием доброкачественной опухоли.
2. p - value:
статистически незначимо p - value > 0,05- влияние средней площади и среднего радиуса на диагностирование признака опухоли ( 0 или 1)  
статистически значимо p - value < 0,05 - влияние средней текстуры на диагностирование признака опухоли  ( 0 или 1) 

3. отклонения интерпретировать сложно. 
Проведем преобразование коэффициентов можели для лучшей интерпретации:
```{r}
exp(coefficients(glr1))
```
Вывод: статистической значимы все факторы, но фактор средней текстуры опухоли больше  в 1,23 раза при диагностировании доброкачественной опухоли

Визуализируем кривые логистической регрессии по каждому фактору:
```{r}
cancer %>%
    ggplot(aes(x = radius_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и среднего радиуса опухоли",
      x = "Средний радиус опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
cancer %>%
    ggplot(aes(x = texture_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и сренего значения текстуры опухоли",
      x = "Средняя текстура опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```

```{r}
cancer %>%
    ggplot(aes(x = area_mean, y = diagnosis)) +
    geom_point() +
    labs(title = "Зависимость типа опухоли и средней площади опухоли",
      x = "Средняя площадь опухоли",
      y = "Тип опухоли") +
    geom_smooth(method = "glm", 
                method.args = list(family = "binomial")) +
  theme_bw()
```
СОздаем логистическую регрессионную  модель, отражающую прогноз вероятности возникновения злокачественной опухоли от всех трех перечисленных факторов при их взаимодействии.
```{r}
glr2 <-
  glm(diagnosis ~ radius_mean * area_mean * texture_mean,
      data = cancer,
      family = "binomial")

summary(glr2)
```
АНализ полученных результатов: во всех исследуемых случаях p - value > 0,05, что говорит о незначимости взаимодействия факторов на прогноз возникновения злокачественной опухоли.



**Задание 3**
Для выполнения этого задания вам понадобится датасет lung, который встроен в пакет survival. Установите этот пакет и загрузите датасет.

Датасет содержит следующий набор переменных:

inst: код учреждения;
time: время выживаемости в днях;
status: 1 = цензурирование, 2 = смерть;
age: возраст в годах;
sex: мужской = 1, женский = 2;
ph.ecog: шкала опросника ECOG (оценку проводит врач). 0 = отсутствие симптомов, 1= симптомы есть, но пациент наблюдается амбулаторно, 2 = меньше половины дня пациент вынужден проводить в постели, 3 = больше половины дня нуждается в отдыхе лежа, но не прикован к постели, 4 = прикован к постели;
ph.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке врача;
pat.karno: шкала Карновского (от 0 до 100, от худшего к лучшему) по оценке пациента;
meal.cal: калории потребляемой пищи;
wt.loss: потеря веса за последние полгода.
```{r}
lung <- survival::lung
head(lung)
```
**Создайте переменную event, в которой отразите наличие или отсутствие (1 или 0) интересующего события — смерти пациента**
```{r}
lung$event <- ifelse(lung$status == 2,1,0)
head(lung)
```
Создаем выборку пациентов летальных - event - 1
```{r}
lungdeath <- filter(lung,lung$event == 1)
head(lungdeath)
```
**Изучите работу функций Surv(), survfit() и ggsurvplot()**:

1. Постройте кривые выживаемости в зависимости от пола (на одном графике должны получиться две кривые для каждого пола и таблица числа пациентов, подверженных риску (at risk) под ним). Поясните получившееся значение p-value для лог-рангового теста и опишите наблюдаемые результаты.
```{r}
surv_fit <- survfit(Surv(time, status) ~ sex, data = lungdeath)

ggsurvplot(surv_fit, conf.int = TRUE, surv.median.line = 'hv', risk.table = TRUE)
```
Линии графика и доверительные интервалы пересекаются. Различий в выживаемости между полами со временем нет

Формулирую гипотезы
H0- нет  статистически значимой разницы выживаемости в зависимости от пола
H1-есть статистически значимая разница выживаемости в зависимости от пола
alpha = 0.05

проводим лонг-ранг тест для интерпретации р-value
```{r}
survdiff(Surv(time, status) ~ sex, data = lungdeath)
```
По результату лонг-ранг тестирования значение р-value 0,1, что больше установленного alpha 0,05. Мы не можем отклонить нулевую гипотезу - нет  статистически значимой разницы выживаемости в зависимости от пола

2. Постройте график кумулятивной функции рисков (cumulative hazard function) для пола. Проинтерпретируйте график.
```{r}
ggsurvplot(surv_fit, fun = "cumhaz", conf.int = TRUE, risk.table = TRUE)
```
Здесь также, как и в предыдущем, линии графика и доверительные интервалы пересекаются. Различий в уровне риска между полами  нет.

3. С помощью функции coxph() постройте регрессию Кокса и оцените влияние пола на выживаемость. Что вы можете сказать о полученных результатах?
```{r}
cox <- coxph(Surv(time, status) ~ sex, data = lungdeath)
summary(cox)
```
ПО результатам : значение р-value  0.136, принимается нулевая гипотеза - разница по полу на выживаемость статистически незначима.
exp(coef)- уровень относительного риска - 0.7779,  а exp(-coef) 1.285

для анализа проведем преобразования эеспонент для определения риска по полу в %.

```{r}
(1 - 0.7779) * 100 
(1 - 1.285) * 100 
```
Вывод: риск смерти в группе женщин ниже, чем у мужчин на 22.21%
       риск смерти в группе мужчин выше на 28.5%, чем у женщин.
       НО! По результатам регрессии Кокса  - эти отличия неверны.
Все выше проведенные тесты определяют отсутствие  статистически значимой разницы в выживаемости по полу.
МОжно предположить об исползьовании неудачной выборки для оценки выживаемости и риска смерти
       
       
